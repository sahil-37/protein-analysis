<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Protein Report: {{ACCESSION_ID}}</title>
    
    <script type="importmap">
    {
      "imports": {
        "@nightingale-elements/": "https://cdn.jsdelivr.net/npm/@nightingale-elements/"
      }
    }
    </script>

    <!-- Chart.js for charge profile visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

    <style>
        :root {
            --primary-600: #4F46E5;
            --primary-700: #4338CA;
            --primary-50: #EEF2FF;
            --gray-50: #F9FAFB;
            --gray-100: #F3F4F6;
            --gray-200: #E5E7EB;
            --gray-300: #D1D5DB;
            --gray-600: #4B5563;
            --gray-700: #374151;
            --gray-900: #111827;
            --success-500: #10B981;
            --warning-500: #F59E0B;
            --error-500: #EF4444;
            --space-1: 0.25rem;
            --space-2: 0.5rem;
            --space-3: 0.75rem;
            --space-4: 1rem;
            --space-6: 1.5rem;
            --space-8: 2rem;
            --font-sans: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            --font-mono: 'SF Mono', 'Monaco', 'Consolas', monospace;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1);
            --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1);
            --radius-sm: 0.375rem;
            --radius-md: 0.5rem;
            --radius-lg: 0.75rem;
            --radius-xl: 1rem;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: var(--font-sans);
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: var(--gray-900);
            line-height: 1.6;
            min-height: 100vh;
            padding: var(--space-8);
        }
        
        .page-container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .report-card {
            background: white;
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-xl);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, var(--primary-600) 0%, var(--primary-700) 100%);
            color: white;
            padding: var(--space-8);
        }
        
        .header-title {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: var(--space-2);
            display: flex;
            align-items: center;
            gap: var(--space-3);
        }
        
        .protein-badge {
            background: rgba(255, 255, 255, 0.2);
            padding: var(--space-2) var(--space-4);
            border-radius: var(--radius-md);
            font-size: 0.875rem;
            font-weight: 600;
            font-family: var(--font-mono);
            backdrop-filter: blur(10px);
        }
        
        .header-subtitle {
            font-size: 1rem;
            opacity: 0.9;
            font-weight: 400;
        }
        
        .metadata-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--space-4);
            padding: var(--space-6);
            background: var(--gray-50);
            border-bottom: 1px solid var(--gray-200);
        }
        
        .stat-card {
            background: white;
            padding: var(--space-4);
            border-radius: var(--radius-lg);
            border: 1px solid var(--gray-200);
            transition: all 0.2s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }
        
        .stat-label {
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--gray-600);
            margin-bottom: var(--space-2);
        }
        
        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--gray-900);
        }
        
        .stat-unit {
            font-size: 0.875rem;
            color: var(--gray-600);
            font-weight: 400;
            margin-left: var(--space-1);
        }
        
        .content-wrapper {
            padding: var(--space-8);
        }
        
        .section {
            margin-bottom: var(--space-8);
        }
        
        .section-header {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            margin-bottom: var(--space-6);
            padding-bottom: var(--space-4);
            border-bottom: 2px solid var(--gray-200);
        }

        .section-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--gray-900);
        }
        
        .section-description {
            font-size: 0.875rem;
            color: var(--gray-600);
            margin-top: var(--space-2);
        }

        /* Sequence Display */
        .sequence-section {
            background: white;
            border: 1px solid var(--gray-200);
            border-radius: var(--radius-lg);
            padding: var(--space-6);
            margin: var(--space-6) 0;
            box-shadow: var(--shadow-sm);
            width: 100%;
        }

        .sequence-label {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--gray-700);
            margin-bottom: var(--space-3);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .sequence-display {
            background: var(--gray-50);
            border: 1px solid var(--gray-200);
            border-radius: var(--radius-md);
            padding: var(--space-4);
            font-family: monospace;
            font-size: 0.875rem;
            color: var(--gray-800);
            line-height: 1.6;
            word-wrap: break-word;
            white-space: pre-wrap;
            overflow-x: auto;
            width: 100%;
            box-sizing: border-box;
        }

        /* Properties Grid */
        .properties-grid {
            display: flex;
            flex-direction: column;
            gap: var(--space-4);
            margin-top: var(--space-4);
        }

        .property-group {
            background: white;
            border: 1px solid var(--gray-200);
            border-radius: var(--radius-lg);
            padding: var(--space-4);
            box-shadow: var(--shadow-sm);
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: var(--space-4);
        }

        .property-group.horizontal-row {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: var(--space-4);
        }

        .property-group.secondary-row {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: var(--space-4);
        }

        /* Post-Translational Modifications Section */
        .ptm-section {
            background: white;
            border: 1px solid var(--gray-200);
            border-radius: var(--radius-lg);
            padding: var(--space-6);
            margin-bottom: var(--space-6);
            box-shadow: var(--shadow-sm);
        }

        .ptm-section.ptm-empty {
            background: var(--gray-50);
            border-style: dashed;
        }

        .ptm-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-4);
            padding-bottom: var(--space-4);
            border-bottom: 2px solid var(--gray-200);
        }

        .ptm-title {
            font-size: 1rem;
            font-weight: 700;
            color: var(--gray-900);
        }

        .ptm-count {
            background: linear-gradient(135deg, var(--primary-600) 0%, var(--primary-700) 100%);
            color: white;
            padding: var(--space-2) var(--space-3);
            border-radius: var(--radius-md);
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .ptm-overview {
            display: flex;
            flex-wrap: wrap;
            gap: var(--space-3);
            margin-bottom: var(--space-4);
            padding: var(--space-4);
            background: var(--gray-50);
            border-radius: var(--radius-md);
        }

        .ptm-type-badge {
            display: inline-flex;
            align-items: center;
            gap: var(--space-2);
            background: white;
            border: 1px solid var(--gray-200);
            padding: var(--space-2) var(--space-3);
            border-radius: var(--radius-md);
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--gray-700);
        }

        .ptm-count-badge {
            background: var(--primary-100);
            color: var(--primary-700);
            padding: var(--space-1) var(--space-2);
            border-radius: var(--radius-sm);
            font-weight: 700;
            font-size: 0.75rem;
        }

        .ptm-details {
            margin-top: var(--space-4);
            max-height: 500px;
            overflow-y: auto;
            border: 1px solid var(--gray-200);
            border-radius: var(--radius-md);
            padding: var(--space-4);
            background: white;
        }

        .ptm-list {
            display: flex;
            flex-direction: column;
            gap: var(--space-3);
        }

        /* Scrollbar styling */
        .ptm-details::-webkit-scrollbar {
            width: 8px;
        }

        .ptm-details::-webkit-scrollbar-track {
            background: var(--gray-100);
            border-radius: var(--radius-md);
        }

        .ptm-details::-webkit-scrollbar-thumb {
            background: var(--gray-300);
            border-radius: var(--radius-md);
        }

        .ptm-details::-webkit-scrollbar-thumb:hover {
            background: var(--gray-400);
        }

        .ptm-item {
            background: var(--gray-50);
            border-left: 3px solid var(--primary-600);
            padding: var(--space-4);
            border-radius: var(--radius-md);
            display: flex;
            gap: var(--space-4);
            align-items: flex-start;
        }

        .ptm-position {
            font-weight: 700;
            color: var(--primary-600);
            min-width: 80px;
            font-family: var(--font-mono);
            font-size: 0.875rem;
        }

        .ptm-info {
            flex: 1;
        }

        .ptm-type-label {
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--primary-600);
            margin-bottom: var(--space-1);
        }

        .ptm-description {
            font-size: 0.875rem;
            color: var(--gray-700);
            line-height: 1.4;
        }

        .ptm-more-indicator {
            text-align: center;
            padding: var(--space-4);
            color: var(--gray-600);
            font-size: 0.875rem;
            font-style: italic;
            border-top: 1px dashed var(--gray-300);
            margin-top: var(--space-3);
        }

        /* Secondary Structure Comparison Table */
        .sec-struct-table-wrapper {
            background: white;
            border: 1px solid var(--gray-200);
            border-radius: var(--radius-lg);
            padding: var(--space-4);
            margin-top: var(--space-4);
            box-shadow: var(--shadow-sm);
        }

        .sec-struct-comparison {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.95rem;
        }

        .sec-struct-comparison thead {
            background: linear-gradient(135deg, var(--gray-100) 0%, var(--gray-50) 100%);
        }

        .sec-struct-comparison th {
            padding: var(--space-3) var(--space-4);
            text-align: left;
            font-weight: 600;
            color: var(--gray-700);
            border-bottom: 2px solid var(--gray-300);
            text-transform: uppercase;
            font-size: 0.85rem;
            letter-spacing: 0.05em;
        }

        .sec-struct-comparison td {
            padding: var(--space-3) var(--space-4);
            border-bottom: 1px solid var(--gray-200);
        }

        .sec-struct-comparison tbody tr:last-child td {
            border-bottom: none;
        }

        .sec-struct-comparison tbody tr:hover {
            background: var(--gray-50);
        }

        .sec-struct-comparison td:first-child {
            font-weight: 500;
            color: var(--gray-800);
            width: 40%;
        }

        .sec-struct-comparison .pred-value {
            text-align: center;
            color: var(--primary-600);
            font-weight: 600;
        }

        .sec-struct-comparison .exp-value {
            text-align: center;
            color: var(--success-600);
            font-weight: 600;
        }

        .property-group-title {
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--primary-600);
            margin-bottom: var(--space-3);
            padding-bottom: var(--space-2);
            border-bottom: 2px solid var(--primary-100);
        }

        .property-item {
            margin-bottom: var(--space-4);
        }

        .property-item:last-child {
            margin-bottom: 0;
        }

        .property-label {
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--gray-600);
            margin-bottom: var(--space-1);
        }

        .property-value {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--gray-900);
            font-family: var(--font-mono);
        }

        .property-unit {
            font-size: 0.875rem;
            color: var(--gray-600);
            font-weight: 400;
            margin-left: var(--space-1);
        }

        /* Legacy table support */
        .properties-table {
            width: 100%;
            max-width: 700px;
            border-collapse: separate;
            border-spacing: 0;
            border: 1px solid var(--gray-200);
            border-radius: var(--radius-lg);
            overflow: hidden;
            box-shadow: var(--shadow-sm);
        }

        .properties-table th {
            background: linear-gradient(135deg, var(--primary-600) 0%, var(--primary-700) 100%);
            color: white;
            font-weight: 600;
            text-align: left;
            padding: var(--space-4);
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .properties-table td {
            padding: var(--space-4);
            border-bottom: 1px solid var(--gray-200);
        }

        .properties-table tr:last-child td {
            border-bottom: none;
        }

        .properties-table tr:nth-child(even) {
            background: var(--gray-50);
        }

        .properties-table td:first-child {
            font-weight: 600;
            color: var(--gray-700);
        }

        .properties-table td:last-child {
            color: var(--gray-900);
            font-family: var(--font-mono);
            font-size: 0.9375rem;
        }
        
        .viewer-card {
            background: white;
            border: 1px solid var(--gray-200);
            border-radius: var(--radius-xl);
            padding: var(--space-6);
            box-shadow: var(--shadow-md);
            position: relative;
        }
        

        /* Charge Profile Chart */
        .charge-profile-card {
            background: white;
            border: 1px solid var(--gray-200);
            border-radius: var(--radius-xl);
            padding: var(--space-6);
            box-shadow: var(--shadow-md);
            margin-bottom: var(--space-6);
        }

        .charge-profile-container {
            position: relative;
            height: 400px;
            margin-bottom: var(--space-4);
        }

        .charge-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--space-4);
        }

        .charge-stat {
            background: var(--gray-50);
            padding: var(--space-4);
            border-radius: var(--radius-lg);
            border: 1px solid var(--gray-200);
        }

        .charge-stat-label {
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--gray-600);
            margin-bottom: var(--space-2);
        }

        .charge-stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary-600);
        }

        .charge-stat-unit {
            font-size: 0.875rem;
            color: var(--gray-600);
            font-weight: 400;
            margin-left: var(--space-1);
        }

        /* Track Table */
        .track-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
        }
        
        .track-table tr {
            border-bottom: 1px solid var(--gray-100);
        }
        
        .track-table tr:last-child {
            border-bottom: none;
        }
        
        .track-table td {
            padding: var(--space-3) var(--space-2);
        }
        
        .track-label-cell {
            width: 160px;
            padding-right: var(--space-4);
            border-right: 2px solid var(--gray-200);
            background: var(--gray-50);
            vertical-align: middle;
        }
        
        .track-label-wrapper {
            display: flex;
            align-items: center;
            gap: var(--space-2);
            position: relative;
        }
        
        .track-name {
            font-size: 0.8125rem;
            font-weight: 600;
            color: var(--gray-700);
            white-space: nowrap;
        }
        
        .info-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: var(--primary-600);
            color: white;
            font-size: 0.65rem;
            font-weight: 700;
            cursor: help;
            flex-shrink: 0;
        }
        
        .track-tooltip {
            position: absolute;
            left: 100%;
            top: 50%;
            transform: translateY(-50%);
            margin-left: var(--space-2);
            background: var(--gray-900);
            color: white;
            padding: var(--space-2) var(--space-3);
            border-radius: var(--radius-sm);
            font-size: 0.75rem;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s ease;
            z-index: 1000;
        }
        
        .info-icon:hover + .track-tooltip {
            opacity: 1;
        }
        
        .track-content {
            background: white;
        }
        
        .track-table tr:first-child .track-label-cell {
            background: transparent;
            border: none;
        }
        
        /* Make tracks hoverable */
        .track-content nightingale-track,
        .track-content nightingale-sequence,
        .track-content nightingale-colored-sequence {
            cursor: crosshair;
        }

        /* Styling for overlapping PTM features in Nightingale tracks */
        .track-content nightingale-track svg.container {
            /* Increase height to accommodate staggered PTMs */
            height: auto !important;
        }
        
        /* Collapsible Sections */
        .collapsible-section {
            margin-bottom: var(--space-6);
        }

        .collapsible-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: var(--space-4) var(--space-6);
            background: linear-gradient(135deg, var(--primary-50) 0%, var(--gray-50) 100%);
            border: 1px solid var(--gray-200);
            border-radius: var(--radius-lg) var(--radius-lg) 0 0;
            cursor: pointer;
            user-select: none;
            transition: all 0.2s ease;
        }

        .collapsible-section.collapsed .collapsible-header {
            border-radius: var(--radius-lg);
        }

        .collapsible-header:hover {
            background: linear-gradient(135deg, var(--primary-100) 0%, var(--gray-100) 100%);
            box-shadow: var(--shadow-sm);
        }

        .collapsible-title-group {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            flex: 1;
        }

        .collapsible-toggle {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 24px;
            height: 24px;
            font-size: 1.2rem;
            color: var(--primary-600);
            transition: transform 0.2s ease;
        }

        .collapsible-section.collapsed .collapsible-toggle {
            transform: rotate(-90deg);
        }

        .collapsible-title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--gray-900);
        }

        .collapsible-status {
            font-size: 0.75rem;
            font-weight: 500;
            color: var(--gray-600);
            padding: var(--space-2) var(--space-3);
            background: white;
            border-radius: var(--radius-sm);
            border: 1px solid var(--gray-200);
        }

        .collapsible-content {
            border: 1px solid var(--gray-200);
            border-top: none;
            border-radius: 0 0 var(--radius-lg) var(--radius-lg);
            overflow: hidden;
            max-height: 1000px;
            transition: max-height 0.3s ease, opacity 0.3s ease;
            opacity: 1;
        }

        .collapsible-section.collapsed .collapsible-content {
            max-height: 0;
            opacity: 0;
            overflow: hidden;
        }

        .collapsible-body {
            padding: var(--space-6);
            background: white;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .loading {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        
        @media (max-width: 768px) {
            body {
                padding: var(--space-4);
            }
            
            .header-title {
                font-size: 1.5rem;
                flex-direction: column;
                align-items: flex-start;
            }
            
            .metadata-grid {
                grid-template-columns: 1fr;
            }
            
            .content-wrapper {
                padding: var(--space-4);
            }
            
            .track-label-cell {
                width: 100px;
            }
            
            .track-name {
                font-size: 0.75rem;
            }
        }
        
        @media print {
            body {
                background: white;
            }
            
            .report-card {
                box-shadow: none;
            }
            
            .info-icon, .track-tooltip {
                display: none;
            }
        }
    </style>
</head>
<body>
    <div class="page-container">
        <div class="report-card">
            <div class="header">
                <h1 class="header-title">
                    üß¨ Protein Analysis Report
                    <span class="protein-badge">{{ACCESSION_ID}}</span>
                </h1>
                <p class="header-subtitle">Comprehensive biophysical and structural analysis</p>
            </div>
            
            <div class="metadata-grid">
                <div class="stat-card">
                    <div class="stat-label">Protein Name</div>
                    <div class="stat-value">{{PROTEIN_NAME}}</div>
                </div>

                <div class="stat-card">
                    <div class="stat-label">Gene Name</div>
                    <div class="stat-value">{{GENE_NAME}}</div>
                </div>

                <div class="stat-card">
                    <div class="stat-label">Organism of Origin</div>
                    <div class="stat-value">{{ORGANISM}}</div>
                </div>

                <div class="stat-card">
                    <div class="stat-label">UniProt Accession</div>
                    <div class="stat-value">{{ACCESSION_ID}}</div>
                </div>

                <div class="stat-card">
                    <div class="stat-label">Sequence Length</div>
                    <div class="stat-value">
                        {{SEQUENCE_LENGTH}}
                        <span class="stat-unit">amino acids</span>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-label">Annotated Features</div>
                    <div class="stat-value">
                        <span id="feature-count">0</span>
                        <span class="stat-unit">from UniProt</span>
                    </div>
                </div>
            </div>

            <!-- Amino Acid Sequence Section -->
            <div class="sequence-section">
                <div class="sequence-label">Amino Acid Sequence:</div>
                <div class="sequence-display" id="aa-sequence"></div>
            </div>

            <div class="content-wrapper">
                <div class="collapsible-section" id="biophysical-properties-section">
                    <div class="collapsible-header" onclick="toggleCollapsible(this)">
                        <div class="collapsible-title-group">
                            <span class="collapsible-toggle">‚ñº</span>
                            <div>
                                <div class="collapsible-title">Biophysical Properties</div>
                                <p class="section-description">Calculated using BioPython ProtParam with Bjellqvist pKa values</p>
                            </div>
                        </div>
                        <div class="collapsible-status">Level 1 ‚Ä¢ Essential</div>
                    </div>
                    <div class="collapsible-content">
                        <div class="collapsible-body">
                            {{PROTPARAM_TABLE}}
                        </div>
                    </div>
                </div>

                <div class="collapsible-section" id="charge-profile-section">
                    <div class="collapsible-header" onclick="toggleCollapsible(this)">
                        <div class="collapsible-title-group">
                            <span class="collapsible-toggle">‚ñº</span>
                            <div>
                                <div class="collapsible-title">pH-Dependent Charge Profile</div>
                                <p class="section-description">Net charge of the protein across pH range 2.0 - 12.0</p>
                            </div>
                        </div>
                        <div class="collapsible-status">Level 2 ‚Ä¢ Advanced</div>
                    </div>
                    <div class="collapsible-content">
                        <div class="collapsible-body">
                            <div class="charge-profile-card">
                                <div class="charge-profile-container">
                                    <canvas id="charge-profile-chart"></canvas>
                                </div>

                                <div class="charge-stats">
                                    <div class="charge-stat">
                                        <div class="charge-stat-label">Isoelectric Point (pI)</div>
                                        <div class="charge-stat-value">
                                            <span id="pi-value">-</span>
                                            <span class="charge-stat-unit">pH</span>
                                        </div>
                                    </div>
                                    <div class="charge-stat">
                                        <div class="charge-stat-label">Charge at pH 7.4 (Physiological)</div>
                                        <div class="charge-stat-value">
                                            <span id="charge-74-value">-</span>
                                            <span class="charge-stat-unit">e‚Åª</span>
                                        </div>
                                    </div>
                                    <div class="charge-stat">
                                        <div class="charge-stat-label">Charge Range</div>
                                        <div class="charge-stat-value">
                                            <span id="charge-min-value">-</span>
                                            <span class="charge-stat-unit">to</span>
                                            <span id="charge-max-value">-</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="collapsible-section" id="protein-viewer-section">
                    <div class="collapsible-header" onclick="toggleCollapsible(this)">
                        <div class="collapsible-title-group">
                            <span class="collapsible-toggle">‚ñº</span>
                            <div>
                                <div class="collapsible-title">Interactive Protein Viewer</div>
                                <p class="section-description">Hover over colored features to see position, length, and Feature ID</p>
                            </div>
                        </div>
                        <div class="collapsible-status">Level 2 ‚Ä¢ Advanced</div>
                    </div>
                    <div class="collapsible-content">
                        <div class="collapsible-body">
                            <div class="viewer-card">
                        <nightingale-manager id="viewer-manager">
                            <table class="track-table">
                                <tbody>
                                    <tr>
                                        <td class="track-label-cell"></td>
                                        <td class="track-content">
                                            <nightingale-navigation id="navigation" min-width="900" height="40" length="{{SEQUENCE_LENGTH}}" display-start="1" display-end="{{SEQUENCE_LENGTH}}" margin-color="white"></nightingale-navigation>
                                        </td>
                                    </tr>
                                    
                                    <tr>
                                        <td class="track-label-cell">
                                            <div class="track-label-wrapper">
                                                <span class="track-name">Sequence</span>
                                                <span class="info-icon">i</span>
                                                <span class="track-tooltip">Amino acid letters (one-letter code)</span>
                                            </div>
                                        </td>
                                        <td class="track-content">
                                            <nightingale-sequence id="sequence" min-width="900" height="40" length="{{SEQUENCE_LENGTH}}" display-start="1" display-end="{{SEQUENCE_LENGTH}}" margin-color="white" highlight-event="onmouseover"></nightingale-sequence>
                                        </td>
                                    </tr>
                                    
                                    <tr>
                                        <td class="track-label-cell">
                                            <div class="track-label-wrapper">
                                                <span class="track-name">Hydrophobicity</span>
                                                <span class="info-icon">i</span>
                                                <span class="track-tooltip">Kyte-Doolittle scale: Blue=polar, Red=nonpolar</span>
                                            </div>
                                        </td>
                                        <td class="track-content">
                                            <nightingale-colored-sequence id="colored-sequence" min-width="900" height="20" length="{{SEQUENCE_LENGTH}}" display-start="1" display-end="{{SEQUENCE_LENGTH}}" scale="hydrophobicity-scale" margin-color="white" highlight-event="onmouseover"></nightingale-colored-sequence>
                                        </td>
                                    </tr>
                                    
                                    <tr>
                                        <td class="track-label-cell">
                                            <div class="track-label-wrapper">
                                                <span class="track-name">Chain</span>
                                                <span class="info-icon">i</span>
                                                <span class="track-tooltip">Mature protein after signal peptide cleavage</span>
                                            </div>
                                        </td>
                                        <td class="track-content">
                                            <nightingale-track id="chain" layout="non-overlapping" min-width="900" height="20" length="{{SEQUENCE_LENGTH}}" display-start="1" display-end="{{SEQUENCE_LENGTH}}" margin-color="white" highlight-event="onmouseover"></nightingale-track>
                                        </td>
                                    </tr>
                                    
                                    <tr>
                                        <td class="track-label-cell">
                                            <div class="track-label-wrapper">
                                                <span class="track-name">Domain</span>
                                                <span class="info-icon">i</span>
                                                <span class="track-tooltip">Conserved functional/structural domains</span>
                                            </div>
                                        </td>
                                        <td class="track-content">
                                            <nightingale-track id="domain" min-width="900" height="20" length="{{SEQUENCE_LENGTH}}" display-start="1" display-end="{{SEQUENCE_LENGTH}}" margin-color="white" highlight-event="onmouseover"></nightingale-track>
                                        </td>
                                    </tr>
                                    
                                    <tr>
                                        <td class="track-label-cell">
                                            <div class="track-label-wrapper">
                                                <span class="track-name">Region</span>
                                                <span class="info-icon">i</span>
                                                <span class="track-tooltip">Regions of interest (disordered, coiled-coil, etc.)</span>
                                            </div>
                                        </td>
                                        <td class="track-content">
                                            <nightingale-track id="region" min-width="900" height="20" length="{{SEQUENCE_LENGTH}}" display-start="1" display-end="{{SEQUENCE_LENGTH}}" margin-color="white" highlight-event="onmouseover"></nightingale-track>
                                        </td>
                                    </tr>
                                    
                                    <tr>
                                        <td class="track-label-cell">
                                            <div class="track-label-wrapper">
                                                <span class="track-name">Site</span>
                                                <span class="info-icon">i</span>
                                                <span class="track-tooltip">Functionally important sites (active site, etc.)</span>
                                            </div>
                                        </td>
                                        <td class="track-content">
                                            <nightingale-track id="site" min-width="900" height="20" length="{{SEQUENCE_LENGTH}}" display-start="1" display-end="{{SEQUENCE_LENGTH}}" margin-color="white" highlight-event="onmouseover"></nightingale-track>
                                        </td>
                                    </tr>
                                    
                                    <tr>
                                        <td class="track-label-cell">
                                            <div class="track-label-wrapper">
                                                <span class="track-name">Binding Site</span>
                                                <span class="info-icon">i</span>
                                                <span class="track-tooltip">Residues involved in ligand/substrate binding</span>
                                            </div>
                                        </td>
                                        <td class="track-content">
                                            <nightingale-track id="binding" min-width="900" height="20" length="{{SEQUENCE_LENGTH}}" display-start="1" display-end="{{SEQUENCE_LENGTH}}" margin-color="white" highlight-event="onmouseover"></nightingale-track>
                                        </td>
                                    </tr>
                                    
                                    <tr>
                                        <td class="track-label-cell">
                                            <div class="track-label-wrapper">
                                                <span class="track-name">Disulfide Bond</span>
                                                <span class="info-icon">i</span>
                                                <span class="track-tooltip">Cysteine pairs forming S-S bridges</span>
                                            </div>
                                        </td>
                                        <td class="track-content">
                                            <nightingale-track id="disulfide-bond" layout="non-overlapping" min-width="900" height="20" length="{{SEQUENCE_LENGTH}}" display-start="1" display-end="{{SEQUENCE_LENGTH}}" margin-color="white" highlight-event="onmouseover"></nightingale-track>
                                        </td>
                                    </tr>
                                    
                                    <tr>
                                        <td class="track-label-cell">
                                            <div class="track-label-wrapper">
                                                <span class="track-name">Beta Strand</span>
                                                <span class="info-icon">i</span>
                                                <span class="track-tooltip">Œ≤-sheet secondary structure elements</span>
                                            </div>
                                        </td>
                                        <td class="track-content">
                                            <nightingale-track id="beta-strand" min-width="900" height="20" length="{{SEQUENCE_LENGTH}}" display-start="1" display-end="{{SEQUENCE_LENGTH}}" margin-color="white" highlight-event="onmouseover"></nightingale-track>
                                        </td>
                                    </tr>
                                    
                                    <tr>
                                        <td class="track-label-cell">
                                            <div class="track-label-wrapper">
                                                <span class="track-name">Helix</span>
                                                <span class="info-icon">i</span>
                                                <span class="track-tooltip">Œ±-helix secondary structure elements</span>
                                            </div>
                                        </td>
                                        <td class="track-content">
                                            <nightingale-track id="helix" min-width="900" height="20" length="{{SEQUENCE_LENGTH}}" display-start="1" display-end="{{SEQUENCE_LENGTH}}" margin-color="white" highlight-event="onmouseover"></nightingale-track>
                                        </td>
                                    </tr>
                                    
                                    <tr>
                                        <td class="track-label-cell">
                                            <div class="track-label-wrapper">
                                                <span class="track-name">Turn</span>
                                                <span class="info-icon">i</span>
                                                <span class="track-tooltip">Œ≤-turn secondary structure elements</span>
                                            </div>
                                        </td>
                                        <td class="track-content">
                                            <nightingale-track id="turn" min-width="900" height="20" length="{{SEQUENCE_LENGTH}}" display-start="1" display-end="{{SEQUENCE_LENGTH}}" margin-color="white" highlight-event="onmouseover"></nightingale-track>
                                        </td>
                                    </tr>
                                    
                                    <tr>
                                        <td class="track-label-cell">
                                            <div class="track-label-wrapper">
                                                <span class="track-name">Modified Residue</span>
                                                <span class="info-icon">i</span>
                                                <span class="track-tooltip">Post-translational modifications (PTMs)</span>
                                            </div>
                                        </td>
                                        <td class="track-content">
                                            <nightingale-track id="mod-res" layout="non-overlapping" min-width="900" height="50" length="{{SEQUENCE_LENGTH}}" display-start="1" display-end="{{SEQUENCE_LENGTH}}" margin-color="white" highlight-event="onmouseover"></nightingale-track>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </nightingale-manager>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Collapsible PTM Section -->
                <div class="collapsible-section" id="ptm-description-section">
                    <div class="collapsible-header" onclick="toggleCollapsible(this)">
                        <div class="collapsible-title-group">
                            <span class="collapsible-toggle">‚ñº</span>
                            <div>
                                <div class="collapsible-title">Post-Translational Modifications</div>
                                <p class="section-description">Detailed PTM information and descriptions</p>
                            </div>
                        </div>
                        <div class="collapsible-status">Level 2 ‚Ä¢ Advanced</div>
                    </div>
                    <div class="collapsible-content">
                        <div class="collapsible-body">
                            {{PTM_SECTION}}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Collapsible section toggle script -->
    <script>
        // Global toggle function for collapsible sections
        window.toggleCollapsible = function(header) {
            const section = header.closest('.collapsible-section');
            if (section) {
                const isCollapsed = section.classList.toggle('collapsed');
                console.log('Toggled section:', section.id, '- now collapsed:', isCollapsed);
            }
        };

        // Initialize all collapsible sections as expanded by default
        document.addEventListener('DOMContentLoaded', function() {
            // Keep Level 2 sections collapsed initially (Advanced)
            const chargeProfileSection = document.getElementById('charge-profile-section');
            const proteinViewerSection = document.getElementById('protein-viewer-section');
            const ptmDescriptionSection = document.getElementById('ptm-description-section');

            if (chargeProfileSection) {
                chargeProfileSection.classList.add('collapsed');
                console.log('Collapsed charge-profile-section');
            }
            if (proteinViewerSection) {
                proteinViewerSection.classList.add('collapsed');
                console.log('Collapsed protein-viewer-section');
            }
            if (ptmDescriptionSection) {
                ptmDescriptionSection.classList.add('collapsed');
                console.log('Collapsed ptm-description-section');
            }
        });
    </script>

    <script type="module">
        import "@nightingale-elements/nightingale-sequence@latest";
        import "@nightingale-elements/nightingale-track@latest";
        import "@nightingale-elements/nightingale-manager@latest";
        import "@nightingale-elements/nightingale-navigation@latest";
        import "@nightingale-elements/nightingale-colored-sequence@latest";

        const sequence = "{{SEQUENCE}}";
        const features = {{FEATURES_JSON}};
        const sequenceLength = {{SEQUENCE_LENGTH}};
        const chargeProfileData = {{CHARGE_PROFILE_JSON}};

        console.log("=== Protein Report ===");
        console.log("Sequence:", sequence.length, "aa");
        console.log("Features:", features.length);

        document.getElementById('feature-count').textContent = features.length;

        // Initialize charge profile chart
        if (chargeProfileData && chargeProfileData.ph_values) {
            initializeChargeProfile(chargeProfileData);
        }
        
        await Promise.all([
            customElements.whenDefined('nightingale-sequence'),
            customElements.whenDefined('nightingale-colored-sequence'),
            customElements.whenDefined('nightingale-track'),
            customElements.whenDefined('nightingale-navigation'),
            customElements.whenDefined('nightingale-manager')
        ]);
        
        console.log("‚úì Components loaded");

        // Debug: Inspect Nightingale's rendered elements
        console.log("\n=== NIGHTINGALE DEBUG ===");
        const regionTrack = document.querySelector("#region");
        if (regionTrack) {
            console.log("Region track found:", regionTrack);
            console.log("Track properties:", {
                tagName: regionTrack.tagName,
                id: regionTrack.id,
                hasChildNodes: regionTrack.childNodes.length,
                hasSlot: !!regionTrack.querySelector('slot'),
                shadowRoot: !!regionTrack.shadowRoot
            });

            // Try to access shadow DOM
            if (regionTrack.shadowRoot) {
                const shadowElements = regionTrack.shadowRoot.querySelectorAll('*');
                console.log("Shadow DOM elements:", shadowElements.length);

                // Look for SVG or canvas elements
                const svgElements = regionTrack.shadowRoot.querySelectorAll('svg');
                const canvasElements = regionTrack.shadowRoot.querySelectorAll('canvas');
                console.log("SVG elements in shadow:", svgElements.length);
                console.log("Canvas elements in shadow:", canvasElements.length);

                if (svgElements.length > 0) {
                    console.log("Found SVG rendering - features are probably SVG rects/paths");
                }
            }
        }
        console.log("=== END DEBUG ===\n");

        document.querySelector("#sequence").data = sequence;
        document.querySelector("#colored-sequence").data = sequence;

        // Display sequence in the sequence section with line breaks for readability
        const aaSequenceDiv = document.getElementById('aa-sequence');
        if (aaSequenceDiv) {
            // Format sequence in groups of 50 characters per line for readability
            let formattedSequence = '';
            const chunkSize = 50;
            for (let i = 0; i < sequence.length; i += chunkSize) {
                formattedSequence += sequence.substring(i, i + chunkSize) + '\n';
            }
            aaSequenceDiv.textContent = formattedSequence.trim();
        }
        
        // Format features with tooltip information and handle overlapping PTMs
        let rawProcessedFeatures = features.map(ft => {
            const startStr = ft.start || ft.begin;
            const endStr = ft.end || startStr;
            // Convert to numbers for calculation
            const start = parseInt(startStr);
            const end = parseInt(endStr);
            const size = end - start + 1;
            const featureId = ft.ftId || 'N/A';
            const description = ft.description || ft.type || 'Unknown feature';

            // Map PTM types to display names for tooltip
            const ptmTypeNames = {
                'MOD_RES': 'Modified Residue',
                'CARBOHYD': 'Glycosylation',
                'DISULFID': 'Disulfide Bond',
                'CROSSLNK': 'Cross-link',
                'LIPID': 'Lipidation'
            };

            // Create tooltip text
            let tooltipText = `${description}\nPosition: ${start}-${end} aa\nSize: ${size} aa`;

            // Add PTM type if this is a PTM feature
            if (ft.category === 'PTM') {
                const ptmType = ptmTypeNames[ft.type] || ft.type;
                tooltipText += `\nPTM Type: ${ptmType}`;
            }

            tooltipText += `\nFeature ID: ${featureId}`;

            return {
                ...ft,
                start: start,
                end: end,
                title: tooltipText,
                tooltipContent: tooltipText,
                label: `${description} (${start}-${end})`,
                // These will be updated by assignOffsetForOverlappingPTMs
                rowOffset: 0,
                totalRowsAtPosition: 1
            };
        });

        // Function to detect overlapping PTM features and enhance tooltips
        // Nightingale's layout="non-overlapping" handles automatic vertical positioning
        function assignOffsetForOverlappingPTMs(features) {
            // Only apply tooltip enhancement to PTM features (MOD_RES, CARBOHYD, CROSSLNK, LIPID, DISULFID)
            const ptmFeatures = features.filter(f => f.category === 'PTM');
            const nonPTMFeatures = features.filter(f => f.category !== 'PTM');

            // Group PTM features by position (start position) to detect overlaps
            const featuresByPosition = {};
            ptmFeatures.forEach(f => {
                if (!featuresByPosition[f.start]) {
                    featuresByPosition[f.start] = [];
                }
                featuresByPosition[f.start].push(f);
            });

            // Enhance tooltips for PTM features that have overlapping features at same position
            ptmFeatures.forEach(f => {
                const featuresAtPosition = featuresByPosition[f.start];
                const offset = featuresAtPosition.indexOf(f);

                // Update tooltip to show if multiple PTMs at same position
                // Nightingale's layout="non-overlapping" will handle automatic vertical positioning
                if (featuresAtPosition.length > 1) {
                    f.title += `\n\n‚ö†Ô∏è  ${featuresAtPosition.length} PTMs at position ${f.start}`;
                    f.title += `\n[${offset + 1} of ${featuresAtPosition.length}]`;
                }
            });

            // Combine back
            return [...nonPTMFeatures, ...ptmFeatures];
        }

        const processedFeatures = assignOffsetForOverlappingPTMs(rawProcessedFeatures);
        
        // Helper function to get all PTM features EXCEPT disulfides
        function getAllPTMFeaturesExceptDisulfides(allFeatures) {
            // Map PTM feature types to display names
            const ptmTypeNames = {
                'MOD_RES': 'Modified Residue',
                'CARBOHYD': 'Glycosylation',
                'CROSSLNK': 'Cross-link',
                'LIPID': 'Lipidation'
            };

            const ptmFeatures = allFeatures.filter(feature => {
                // Get all PTMs EXCEPT DISULFID (which has its own track)
                return feature.category === 'PTM' && feature.type !== 'DISULFID';
            }).map(feature => ({
                ...feature,
                // Ensure type is set for display
                displayType: ptmTypeNames[feature.type] || feature.type,
                // Add ftId if not present
                ftId: feature.ftId || ''
            }));

            console.log(`getAllPTMFeaturesExceptDisulfides: Found ${ptmFeatures.length} PTM features (excluding DISULFID) from ${allFeatures.length} total features`);
            if (ptmFeatures.length > 0) {
                console.log('Sample PTM feature:', ptmFeatures[0]);
            }

            return ptmFeatures;
        }

        const trackMap = {
            'chain': 'CHAIN',
            'domain': 'DOMAIN',
            'region': 'REGION',
            'site': 'SITE',
            'binding': 'BINDING',
            'disulfide-bond': 'DISULFID',
            'beta-strand': 'STRAND',
            'helix': 'HELIX',
            'turn': 'TURN',
            'mod-res': 'PTM_NO_DISULFID'  // All PTMs except disulfides
        };

        // Store feature data for tooltip lookups
        const featuresByTrack = {};
        const svgElementToFeature = new Map();  // Map SVG elements to their feature data

        for (const [trackId, featureType] of Object.entries(trackMap)) {
            const track = document.querySelector(`#${trackId}`);
            if (track) {
                let filteredFeatures;

                // For PTM track, get all PTM features except disulfides
                if (featureType === 'PTM_NO_DISULFID') {
                    filteredFeatures = getAllPTMFeaturesExceptDisulfides(processedFeatures);
                } else {
                    // For other tracks, filter by specific type
                    filteredFeatures = processedFeatures.filter(({ type }) => type === featureType);
                }

                track.data = filteredFeatures;
                featuresByTrack[trackId] = filteredFeatures;

                console.log(`Track '${trackId}' (${featureType}): ${filteredFeatures.length} features`);

                // Debug: show sample of PTM features if this is the PTM track
                if (featureType === 'PTM' && filteredFeatures.length > 0) {
                    console.log(`  ‚Üí Sample PTM features:`, filteredFeatures.slice(0, 3));
                }

                // Find SVG elements in the track and attach tooltips to them
                const svg = track.querySelector('svg.container');
                if (svg) {
                    const featureGroups = svg.querySelectorAll('g.feature-group');
                    console.log(`  ‚Üí Found ${featureGroups.length} SVG feature elements`);

                    // Map each SVG feature group to its data
                    featureGroups.forEach((svgGroup, index) => {
                        const feature = filteredFeatures[index];
                        if (feature) {
                            svgElementToFeature.set(svgGroup, feature);

                            // Add hover listeners to SVG element
                            svgGroup.style.cursor = 'pointer';

                            svgGroup.addEventListener('mouseenter', (e) => {
                                if (feature.title) {
                                    showTooltip(e.clientX, e.clientY, feature.title);
                                }
                            });

                            svgGroup.addEventListener('mousemove', (e) => {
                                if (feature.title) {
                                    showTooltip(e.clientX, e.clientY, feature.title);
                                }
                            });

                            svgGroup.addEventListener('mouseleave', () => {
                                hideTooltip();
                            });
                        }
                    });
                } else {
                    console.warn(`  ‚Üí No SVG found in track '${trackId}'`);
                }
            }
        }

        // Tooltip display functions
        function showTooltip(clientX, clientY, text) {
            let tooltip = document.getElementById('feature-tooltip');
            if (!tooltip) {
                tooltip = document.createElement('div');
                tooltip.id = 'feature-tooltip';
                tooltip.style.cssText = `
                    position: fixed;
                    background: rgba(0,0,0,0.95);
                    color: white;
                    padding: 10px 14px;
                    border-radius: 6px;
                    font-size: 13px;
                    white-space: pre-line;
                    z-index: 10000;
                    pointer-events: none;
                    max-width: 350px;
                    line-height: 1.5;
                    box-shadow: 0 2px 8px rgba(0,0,0,0.3);
                    font-family: monospace;
                `;
                document.body.appendChild(tooltip);
            }
            tooltip.textContent = text;
            tooltip.style.left = (clientX + 15) + 'px';
            tooltip.style.top = (clientY + 15) + 'px';
            tooltip.style.display = 'block';
        }

        function hideTooltip() {
            const tooltip = document.getElementById('feature-tooltip');
            if (tooltip) {
                tooltip.style.display = 'none';
            }
        }

        console.log("‚úì Report fully loaded");
        console.log("üí° Hover over colored features to see position, length, and Feature ID!");

        // Function to initialize charge profile chart
        function initializeChargeProfile(data) {
            const ctx = document.getElementById('charge-profile-chart');
            if (!ctx) {
                console.warn("Chart canvas not found");
                return;
            }

            const pi = data.isoelectric_point;
            const charge74 = data.charge_at_ph_7_4;
            const phValues = data.ph_values;
            const charges = data.charges;

            // Update stat cards
            document.getElementById('pi-value').textContent = pi.toFixed(2);
            document.getElementById('charge-74-value').textContent = charge74.toFixed(2);

            const minCharge = Math.min(...charges);
            const maxCharge = Math.max(...charges);
            document.getElementById('charge-min-value').textContent = minCharge.toFixed(2);
            document.getElementById('charge-max-value').textContent = maxCharge.toFixed(2);

            // Create Chart.js chart
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: phValues.map(ph => ph.toFixed(1)),
                    datasets: [
                        {
                            label: 'Net Charge',
                            data: charges,
                            borderColor: '#2E86AB',
                            backgroundColor: 'rgba(46, 134, 171, 0.1)',
                            borderWidth: 3,
                            fill: true,
                            tension: 0.4,
                            pointRadius: 3,
                            pointBackgroundColor: '#2E86AB',
                            pointBorderColor: '#fff',
                            pointBorderWidth: 1,
                            pointHoverRadius: 6
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    plugins: {
                        legend: {
                            display: true,
                            labels: {
                                font: { size: 12, weight: '600' },
                                color: '#374151',
                                padding: 15,
                                usePointStyle: true,
                                pointStyle: 'circle'
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            titleColor: '#fff',
                            bodyColor: '#fff',
                            borderColor: '#2E86AB',
                            borderWidth: 1,
                            padding: 12,
                            titleFont: { size: 13, weight: 'bold' },
                            bodyFont: { size: 12 },
                            usePointStyle: true,
                            callbacks: {
                                title: (tooltipItems) => {
                                    return `pH: ${tooltipItems[0].label}`;
                                },
                                label: (tooltipItem) => {
                                    return `Net Charge: ${tooltipItem.parsed.y.toFixed(3)} e‚Åª`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'pH',
                                font: { size: 13, weight: 'bold' },
                                color: '#374151'
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)',
                                drawBorder: true,
                                borderColor: '#D1D5DB'
                            },
                            ticks: {
                                color: '#6B7280',
                                font: { size: 11 }
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Net Charge (e‚Åª)',
                                font: { size: 13, weight: 'bold' },
                                color: '#374151'
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)',
                                drawBorder: true,
                                borderColor: '#D1D5DB'
                            },
                            ticks: {
                                color: '#6B7280',
                                font: { size: 11 }
                            }
                        }
                    }
                }
            });

            console.log("‚úì Charge profile chart rendered");
        }
    </script>
</body>
</html>

    <!-- ADD THIS JUST BEFORE </body> tag for working tooltips -->
    <script>
    // Custom tooltip that definitely works
    (function() {
        const tooltip = document.createElement('div');
        tooltip.id = 'custom-feature-tooltip';
        tooltip.style.cssText = `
            position: fixed;
            background: rgba(17, 24, 39, 0.95);
            color: white;
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 13px;
            font-family: -apple-system, sans-serif;
            pointer-events: none;
            z-index: 100000;
            display: none;
            max-width: 320px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.1);
        `;
        document.body.appendChild(tooltip);

        let currentFeature = null;
        
        // Add listeners to all track elements
        setTimeout(() => {
            document.querySelectorAll('nightingale-track').forEach(track => {
                const trackElement = track;
                
                // Try to access shadow root for hover detection
                if (trackElement.shadowRoot) {
                    const svg = trackElement.shadowRoot.querySelector('svg');
                    if (svg) {
                        svg.addEventListener('mousemove', (e) => {
                            // Get all features for this track
                            const features = trackElement.data || [];
                            
                            // Simple hit detection - find if mouse is over any feature
                            // This is approximate but works
                            const rect = svg.getBoundingClientRect();
                            const x = e.clientX - rect.left;
                            const trackWidth = rect.width;
                            const trackLength = parseInt(trackElement.getAttribute('length')) || 100;
                            const position = Math.floor((x / trackWidth) * trackLength);
                            
                            // Find feature at this position
                            const feature = features.find(f => {
                                const start = f.start || f.begin || 0;
                                const end = f.end || start;
                                return position >= start && position <= end;
                            });
                            
                            if (feature && feature !== currentFeature) {
                                currentFeature = feature;
                                const start = feature.start || feature.begin || '?';
                                const end = feature.end || start;
                                const featureId = feature.ftId || feature.id || 'N/A';
                                const description = feature.description || feature.type || 'Unknown';
                                
                                tooltip.innerHTML = `
                                    <div style="font-weight: 600; margin-bottom: 8px; font-size: 14px; color: #93c5fd;">${description}</div>
                                    <div style="margin: 4px 0;"><strong>Position:</strong> ${start}-${end}</div>
                                    <div style="margin: 4px 0;"><strong>Length:</strong> ${end - start + 1} aa</div>
                                    <div style="margin: 4px 0;"><strong>Feature ID:</strong> ${featureId}</div>
                                `;
                                tooltip.style.display = 'block';
                                tooltip.style.left = (e.clientX + 15) + 'px';
                                tooltip.style.top = (e.clientY + 15) + 'px';
                            } else if (!feature) {
                                tooltip.style.display = 'none';
                                currentFeature = null;
                            }
                        });
                        
                        svg.addEventListener('mouseleave', () => {
                            tooltip.style.display = 'none';
                            currentFeature = null;
                        });
                        
                        // Update tooltip position on mouse move
                        svg.addEventListener('mousemove', (e) => {
                            if (tooltip.style.display === 'block') {
                                tooltip.style.left = (e.clientX + 15) + 'px';
                                tooltip.style.top = (e.clientY + 15) + 'px';
                            }
                        });
                    }
                }
            });
            
            console.log("‚úì Custom tooltip system activated");
        }, 2000); // Wait for tracks to fully render
    })();
    </script>